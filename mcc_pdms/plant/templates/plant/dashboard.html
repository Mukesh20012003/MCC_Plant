{% extends "plant/base.html" %}

{% block content %}
<div class="container-fluid py-4">

  <!-- Page header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-1">Plant Overview</h1>
      <p class="dashboard-subtitle mb-0">
        Welcome, {{ request.user.username }} &nbsp;|&nbsp;
        {% with role=request.user.profile.role %}
          Role:
          {% if role == "ADMIN" %}
            ADMIN
          {% elif role == "PLANT_MANAGER" %}
            PLANT MANAGER
          {% elif role == "QC_ANALYST" %}
            QC ANALYST
          {% else %}
            OPERATOR
          {% endif %}
        {% endwith %}
      </p>
    </div>
    <div>
      <a href="{% url 'logout' %}" class="btn btn-outline-danger btn-sm">Logout</a>
    </div>
  </div>

  <!-- Top metric cards -->
  <div class="row g-3 mb-4">
    <!-- Total Batches -->
    <div class="col-md-4">
      <div class="card card-pdms">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h5 class="card-title">Total Batches</h5>
              <p class="display-6 mb-0">{{ total_batches }}</p>
              <p class="text-muted small mb-0">
                All recorded MCC production batches.
              </p>
            </div>
            <a href="{% url 'batches_list' %}" class="btn btn-outline-secondary btn-sm">
              View
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Predicted to Pass -->
    <div class="col-md-4">
      <div class="card card-pdms">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h5 class="card-title">Predicted to Pass</h5>
              <p class="display-6 mb-0">{{ predicted_to_pass }}</p>
              <p class="text-muted small mb-0">
                Batches with ML prediction = pass.
              </p>
            </div>
            <a href="{% url 'predicted_to_pass_list' %}" class="btn btn-outline-secondary btn-sm">
              View
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- QC Reports -->
    <div class="col-md-4">
      <div class="card card-pdms">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h5 class="card-title">QC Reports</h5>
              <p class="display-6 mb-0">{{ total_qc_reports }}</p>
              <p class="text-muted small mb-0">
                Total QC records stored.
              </p>
            </div>
            <a href="{% url 'qc_reports_list' %}" class="btn btn-outline-secondary btn-sm">
              View
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Second row -->
  <div class="row g-3">
    <!-- Quick Actions -->
    <div class="col-lg-6">
      <div class="card card-pdms h-100">
        <div class="card-body">
          <h5 class="card-title">Quick Actions</h5>
          <p class="text-muted small">
            Create new records and run ML predictions directly from the dashboard.
          </p>

          {% with role=request.user.profile.role %}

            {% if role == "ADMIN" %}
              <a href="{% url 'create_raw_material' %}"
                 class="btn btn-ghost-light btn-sm me-2 mt-1">
                Add Raw Material
              </a>
            {% endif %}

            {% if role == "ADMIN" or role == "PLANT_MANAGER" %}
              <a href="{% url 'create_production_batch' %}"
                 class="btn btn-ghost-light btn-sm me-2 mt-1">
                Add Batch
              </a>
            {% endif %}

            {% if role == "ADMIN" or role == "QC_ANALYST" %}
              <a href="{% url 'create_qc_report' %}"
                 class="btn btn-ghost-light btn-sm me-2 mt-1">
                Add QC Report
              </a>
            {% endif %}

            <a href="{% url 'batches_list' %}"
               class="btn btn-ghost-light btn-sm me-2 mt-1">
              View All Batches
            </a>

            {% if role == "ADMIN" %}
              <a href="{% url 'run_predictions' %}"
                 class="btn btn-primary btn-sm mt-1">
                Run Predictions for Completed Batches
              </a>
            {% endif %}

          {% endwith %}
        </div>
      </div>
    </div>

    <!-- Recent Batches -->
    <div class="col-lg-6">
      <div class="card card-pdms h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="card-title">Recent Batches</h5>
            <a href="{% url 'batches_list' %}" class="btn btn-outline-secondary btn-sm">
              View All
            </a>
          </div>
          <p class="text-muted small">
            Latest production batches with status and predictions.
          </p>

          {% if recent_batches %}
            <div class="table-responsive">
              <table class="table table-sm align-middle mb-0 table-pdms">
                <thead>
                  <tr>
                    <th>Batch ID</th>
                    <th>Status</th>
                    <th>Predicted</th>
                    <th>Probability</th>
                  </tr>
                </thead>
                <tbody>
                  {% for batch in recent_batches %}
                    <tr>
                      <td>{{ batch.batch_no }}</td>
                      <td>
                        <span class="badge badge-status
                          {% if batch.status == 'COMPLETED' %} bg-success
                          {% elif batch.status == 'FAILED' %} bg-danger
                          {% else %} bg-warning text-dark
                          {% endif %}">
                          {{ batch.status }}
                        </span>
                      </td>
                      <td>
                        {% if batch.latest_qc and batch.latest_qc.predicted_pass %}
                          Pass
                        {% elif batch.latest_qc and batch.latest_qc.predicted_pass == False %}
                          Fail
                        {% else %}
                          -
                        {% endif %}
                      </td>
                      <td>
                        {% if batch.latest_qc and batch.latest_qc.predicted_probability %}
                          {{ batch.latest_qc.predicted_probability|floatformat:2 }}
                        {% else %}
                          -
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="text-muted small mb-0">
              No recent batches available. Create a new batch from Quick Actions.
            </p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

</div>
{% endblock content %}
