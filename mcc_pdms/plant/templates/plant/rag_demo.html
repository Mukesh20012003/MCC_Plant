<!-- {% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MCC PDMS RAG Demo</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
</head>
<body class="bg-light">
  <div class="container py-4">
    <h1 class="h4 mb-3">MCC PDMS RAG Demo</h1>

    <div class="card shadow-sm">
      <div class="card-body">
        <form id="rag-form" class="mb-3">
          <div class="mb-2">
            <label for="question" class="form-label">Ask a question</label>
            <textarea
              id="question"
              class="form-control"
              rows="3"
              placeholder="Ask about MCC plant process, QC, batches..."
            ></textarea>
          </div>
          <button type="submit" class="btn btn-primary" id="ask-btn">
            Ask
          </button>
          <span id="status" class="ms-2 text-muted small"></span>
        </form>

        <h6>Answer</h6>
        <div id="answer-box" class="border rounded p-2 bg-white" style="min-height: 60px;">
          <span class="text-muted">No answer yet.</span>
        </div>

        <h6 class="mt-3">Sources</h6>
        <ul id="sources-list" class="small mb-0"></ul>
      </div>
    </div>
  </div>

  <script>
  const form = document.getElementById("rag-form");
  const questionEl = document.getElementById("question");
  const answerBox = document.getElementById("answer-box");
  const sourcesList = document.getElementById("sources-list");
  const statusEl = document.getElementById("status");
  const askBtn = document.getElementById("ask-btn");

  form.addEventListener("submit", async function (e) {
    e.preventDefault();
    const question = questionEl.value.trim();
    if (!question) return;

    statusEl.textContent = "Asking...";
    askBtn.disabled = true;
    answerBox.textContent = "";
    sourcesList.innerHTML = "";

    // Read the same token React uses
    const token = localStorage.getItem("access");

    try {
      const res = await fetch("/api/rag/query/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: token ? `Bearer ${token}` : "",
        },
        body: JSON.stringify({ question }),
      });

      if (!res.ok) {
        throw new Error("Request failed with status " + res.status);
      }

      const data = await res.json();

      answerBox.textContent = data.answer || "No answer.";

      if (Array.isArray(data.sources) && data.sources.length > 0) {
        data.sources.forEach((s) => {
          const li = document.createElement("li");
          li.textContent = `${s.title} (type=${s.doc_type}, chunk=${s.chunk_index})`;
          sourcesList.appendChild(li);
        });
      } else {
        const li = document.createElement("li");
        li.textContent = "No sources returned.";
        sourcesList.appendChild(li);
      }

      statusEl.textContent = "Done.";
    } catch (err) {
      console.error(err);
      answerBox.textContent = "Error: " + err.message;
      statusEl.textContent = "Error.";
    } finally {
      askBtn.disabled = false;
    }
  });
</script>

</body>
</html> -->
